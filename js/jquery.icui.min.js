var hasProp={}.hasOwnProperty,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};!function(t){var e,n,r,i,a,u,o,s,p,h,l,c,d,f,y,_,m,v,g,D;return s={clone:D=function(t){var e,n,r;if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return new Date(t.getTime());if(t instanceof RegExp)return e="",null!=t.global&&(e+="g"),null!=t.ignoreCase&&(e+="i"),null!=t.multiline&&(e+="m"),null!=t.sticky&&(e+="y"),new RegExp(t.source,e);null!=t.parent&&null!=t.data?(r=new t.constructor(t.parent,"__clone"),r.data=D(t.data)):r=new t.constructor;for(n in t)hasProp.call(t,n)&&"parent"!==n&&"data"!==n&&"elem"!==n&&"function"!=typeof t[n]&&(r[n]=D(t[n]));return r},option:function(t,e,n){var r;return r="function"==typeof n?n(t):n===t,'<option value="'+t+'"'+(r?' selected="selected"':"")+">"+e+"</option>"},select:function(t,e){var n,r,i;r="<select>";for(i in e)n=e[i],r+=s.option(i,n,t);return r+"</select>"}},c=function(){function e(t,e){this.parent=t,null==e&&(e=null),this.destroy=bind(this.destroy,this),this.clone=bind(this.clone,this),this.children=[],this.data={},"__clone"!==e&&(null!=e?this.fromData(e):this.defaults())}return e.prototype.fromData=function(t){},e.prototype.defaults=function(){},e.prototype.clonable=function(){return!0},e.prototype.destroyable=function(){return this.parent.children.length>1},e.prototype.clone=function(){return this.parent.children.push(s.clone(this)),this.triggerRender()},e.prototype.destroy=function(){return this.elem.slideUp(100,function(t){return function(){return t.parent.children.splice(t.parent.children.indexOf(t),1),t.parent.triggerRender()}}(this))},e.prototype.render=function(){var e;return e=t("<div></div>"),this.clonable()&&e.append(t("<span class='btn clone'>+</span>").click(this.clone)),this.destroyable()&&e.append(t("<span class='btn destroy'>-</span>").click(this.destroy)),e.append(this.renderChildren()),e.children()},e.prototype.renderChildren=function(){var t,e,n,r,i;for(r=this.children,i=[],e=0,n=r.length;n>e;e++)t=r[e],i.push(t.render());return i},e.prototype.triggerRender=function(){return this.parent.triggerRender()},e}(),d=function(e){function n(){n.__super__.constructor.apply(this,arguments),this.parent.after("<div class='icui'></div>"),this.target=this.parent.siblings(".icui").first()}return extend(n,e),n.prototype.clonable=function(){return!1},n.prototype.destroyable=function(){return!1},n.prototype.has_ending_time=!1,n.prototype.has_rules=!1,n.prototype.fromData=function(t){var e,n,r;this.children.push(new y(this,t.start_time)),t.end_time&&(this.has_ending_time=!0,this.children.push(new o(this,t.end_time))),n=[];for(e in t)r=t[e],r.length>0&&"start_time"!==e&&"end_time"!==e&&(this.has_rules=!0,n.push(this.children.push(new _(this,{type:e,values:r}))));return n},n.prototype.defaults=function(){return this.children.push(new y(this))},n.prototype.triggerRender=function(){return this.render()},n.prototype.render=function(){var e;return this.target.html(this.renderChildren()),this.has_ending_time||(e=t("<a href='#'>Add Ending Time</a> "),e.click(function(t){return function(){return t.has_ending_time=!0,e.hide(),t.children.push(new o(t)),t.triggerRender(),!1}}(this)),this.target.append(e),this.target.append("<br />")),this.has_rules?void 0:(e=t("<a href='#'>Add Repetition</a>"),e.click(function(t){return function(){return t.has_rules=!0,e.hide(),t.children.push(new _(t)),t.triggerRender(),!1}}(this)),this.target.append(e))},n.prototype.getData=function(){var t,e,n,r,i,a;for(n={},a=this.children,r=0,i=a.length;i>r;r++)t=a[r],e=t.getData(),n[e.type]?n[e.type]=n[e.type].concat(e.values):n[e.type]=e.values;return n},n}(c),_=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return extend(r,e),r.prototype.defaults=function(){return this.data.type="rtimes",this.children=[new n(this)]},r.prototype.fromData=function(t){var e,r,i,a,u,o,s,p,h;if(this.data.type=t.type,this.data.type.match(/times$/)){for(u=t.values,s=[],e=0,i=u.length;i>e;e++)h=u[e],s.push(this.children.push(new n(this,h)));return s}for(o=t.values,p=[],r=0,a=o.length;a>r;r++)h=o[r],p.push(this.children.push(new f(this,h)));return p},r.prototype.getData=function(){var t,e;return this.data.type.match(/times$/)?(e=function(){var e,n,r,i;for(r=this.children,i=[],e=0,n=r.length;n>e;e++)t=r[e],i.push(t.getData().time);return i}.call(this),{type:this.data.type,values:e}):(e=function(){var e,n,r,i;for(r=this.children,i=[],e=0,n=r.length;n>e;e++)t=r[e],i.push(t.getData());return i}.call(this),{type:this.data.type,values:e})},r.prototype.render=function(){var e;return this.elem=t('<div class="toplevel">Event <select>\n  '+s.option(1,"occurs",function(t){return function(){return t.data.type.match(/^r/)}}(this))+"\n  "+s.option(-1,"doesn't occur",function(t){return function(){return t.data.type.match(/^ex/)}}(this))+"\n</select> on <select>\n  "+s.option("dates","specific dates",function(t){return function(){return t.data.type.match(/times$/)}}(this))+"\n  "+s.option("rules","every",function(t){return function(){return t.data.type.match(/rules$/)}}(this))+"\n</select>\n</div>"),e=this.elem.find("select"),e.first().change(function(t){return function(e){return"1"===e.target.value?t.data.type=t.data.type.replace(/^ex/,"r"):t.data.type=t.data.type.replace(/^r/,"ex")}}(this)),e.last().change(function(t){return function(e){return"dates"===e.target.value?(t.data.type.match(/^r/)?t.data.type="rtimes":t.data.type="extimes",t.children=[new n(t)]):(t.data.type.match(/^r/)?t.data.type="rrules":t.data.type="exrules",t.children=[new f(t)]),t.triggerRender()}}(this)),this.elem.append(r.__super__.render.apply(this,arguments)),this.elem},r}(c),n=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.defaults=function(){var t;return null!=(t=this.data).moment?t.moment:t.moment=moment()},n.prototype.fromData=function(t){return this.data.moment=moment(t)},n.prototype.getData=function(){return this.data},n.prototype.render=function(){var e,r,i;return this.elem=t('<div class="DatePicker">\n  <input type="date" value="'+this.data.moment.format("L")+'" />\n  <input type="time" value="'+this.data.moment.format("LT")+'" />\n</div>'),r=this.elem.find("input"),e=r.first(),i=r.last(),r.change(function(t){return function(n){return t.data.moment=moment(e.val()+" "+i.val(),"L LT")}}(this)),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),y=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.destroyable=function(){return!1},e.prototype.clonable=function(){return!1},e.prototype.getData=function(){return{type:"start_time",values:this.data.moment.format()}},e.prototype.render=function(){return this.elem=e.__super__.render.apply(this,arguments),this.elem.prepend("Start time"),this.elem},e}(n),o=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.destroyable=function(){return!0},e.prototype.clonable=function(){return!1},e.prototype.getData=function(){return{type:"end_time",values:this.data.moment.format()}},e.prototype.render=function(){return this.elem=e.__super__.render.apply(this,arguments),this.elem.prepend("End time"),this.elem},e}(n),f=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.defaults=function(){return this.data.rule_type="IceCube::YearlyRule",this.children=[new v(this)],this.data.interval=1},n.prototype.fromData=function(t){var e,n,r,i;this.data.rule_type=t.rule_type,this.data.interval=t.interval,t.count&&this.children.push(new v(this,{type:"count",value:t.count})),t.until&&this.children.push(new v(this,{type:"until",value:t.until})),n=t.validations,r=[];for(e in n)i=n[e],r.push(this.children.push(new v(this,{type:e,value:i})));return r},n.prototype.getData=function(){var t,e,n,r,i,a,u,o,s,p,h,l,c;for(c={},o=this.children,n=0,a=o.length;a>n;n++)if(t=o[n],"count"!==t.data.type&&"until"!==t.data.type){s=t.getData();for(r in s)l=s[r],c[r]=l}for(e={rule_type:this.data.rule_type,interval:this.data.interval,validations:c},p=this.children,i=0,u=p.length;u>i;i++)if(t=p[i],"count"===t.data.type||"until"===t.data.type){h=t.getData();for(r in h)l=h[r],e[r]=l}return e},n.prototype.render=function(){return this.elem=t('<div class="Rule">\n  Every\n  <input type="number" value="'+this.data.interval+'" size="2" width="30" />\n  '+s.select(this.data.rule_type,{"IceCube::YearlyRule":"years","IceCube::MonthlyRule":"months","IceCube::WeeklyRule":"weeks","IceCube::DailyRule":"days"})+"\n</div>"),this.elem.find("input").change(function(t){return function(e){return t.data.interval=parseInt(e.target.value)}}(this)),this.elem.find("select").change(function(t){return function(e){return t.data.rule_type=e.target.value,t.children=[new v(t)],t.triggerRender()}}(this)),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),v=function(n){function o(){return o.__super__.constructor.apply(this,arguments)}return extend(o,n),o.prototype.defaults=function(){return this.data.type="count",this.children=[new e(this)]},o.prototype.fromData=function(t){var n,i,u,o,s,p,h,l,c,d,f,y,_,v,g;switch(this.data.type=t.type,t.type){case"count":return this.children.push(new e(this,t.value));case"until":return this.children.push(new m(this,t.value));case"day":for(l=t.value,f=[],i=0,p=l.length;p>i;i++)v=l[i],f.push(this.children.push(new r(this,v)));return f;case"day_of_week":c=t.value,y=[];for(u in c)g=c[u],y.push(function(){var t,e,n;for(n=[],t=0,e=g.length;e>t;t++)v=g[t],n.push(this.children.push(new a(this,{nth:v,day:u})));return n}.call(this));return y;default:for(d=t.value,_=[],s=0,h=d.length;h>s;s++)v=d[s],o=this.choices(t.type),n=new o(this,v),_.push(this.children.push(n));return _}},o.prototype.choices=function(t){return{count:e,until:m,day:r,day_of_week:a,day_of_month:i,day_of_year:u,month_of_year:h,offset_from_pascha:l}[t]},o.prototype.getData=function(){var t,e,n,r,i,a;return n=this.data.type,a=function(){var a,u,o,s,p,h,l,c;switch(n){case"count":return this.children[0].getData();case"until":return this.children[0].getData();case"day_of_week":for(r={},p=this.children,a=0,o=p.length;o>a;a++)t=p[a],h=t.getData(),e=h[0],i=h[1],null==r[e]&&(r[e]=[]),r[e].push(i);return r;default:for(l=this.children,c=[],u=0,s=l.length;s>u;u++)t=l[u],c.push(t.getData());return c}}.call(this),r={},r[n]=a,r},o.prototype.destroyable=function(){return!0},o.prototype.render=function(){var e,n;return n='<div class="Validation">\n  '+(this.parent.children.indexOf(this)>0?"and if":"If")+" <select>\n    "+s.option("count","event occured less than",this.data.type)+"\n    "+s.option("until","event is before",this.data.type)+"\n    "+s.option("day","is this day of the week",this.data.type),"IceCube::YearlyRule"!==(e=this.parent.data.rule_type)&&"IceCube::MonthlyRule"!==e||(n+=s.option("day_of_week","is this day of the nth week",this.data.type),n+=s.option("day_of_month","is the nth day of the month",this.data.type)),"IceCube::YearlyRule"===this.parent.data.rule_type&&(n+=s.option("day_of_year","is the nth day of the year",this.data.type),n+=s.option("month_of_year","falls within month",this.data.type),n+=s.option("offset_from_pascha","is offset from Pascha",this.data.type)),n+="  </select>\n</div>",this.elem=t(n),this.elem.find("select").change(function(t){return function(e){var n;return n=t.choices(e.target.value),t.children=[new n(t)],t.data.type=e.target.value,t.triggerRender()}}(this)),this.elem.append(o.__super__.render.apply(this,arguments)),this.elem},o}(c),g=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.defaults=function(){return this.data.value=this["default"]},n.prototype.fromData=function(t){return this.data.value=t},n.prototype.getData=function(){return this.data.value},n.prototype.dataTransformer=parseInt,n.prototype["default"]=1,n.prototype.render=function(){return this.elem=t(this.html()),this.elem.find("input,select").change(function(t){return function(e){return t.data.value=t.dataTransformer(e.target.value)}}(this)),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),e=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.clonable=function(){return!1},e.prototype.html=function(){return'<div class="Count">\n  <input type="number" value='+this.data.value+" /> times.\n</div>"},e}(g),m=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.getData=function(){return this.data.moment.format()},e.prototype.clonable=function(){return!1},e.prototype.destroyable=function(){return!1},e}(n),i=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.html=function(){var t,e,n,r;for(n=function(t){switch(t>10&&20>t?4:t%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}},r='<div class="DayOfMonth">\n  <select>',t=e=1;31>=e;t=++e)r+=s.option(t.toString(),""+t+n(t),this.data.value.toString());return r+=s.option("-1","last",this.data.value.toString()),r+="</select> day of the month.\n</div>"},e}(g),r=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.html=function(){var t,e,n,r,i,a;for(a='<div class="Day">\n  <select>',i=moment.weekdays(),e=n=0,r=i.length;r>n;e=++n)t=i[e],a+=s.option(e.toString(),t,this.data.value.toString());return a+="</select>\n</div>"},e}(g),a=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.getData=function(){return[this.data.day,this.data.nth]},n.prototype.fromData=function(t){this.data=t},n.prototype.defaults=function(){return this.data.nth=1,this.data.day=0},n.prototype.render=function(){var e,r,i,a,u,o,p;for(p='<div class="DayOfWeek">\n  <input type="number" value='+this.data.nth+" /><span>nth</span>.\n  <select>",o=moment.weekdays(),r=i=0,a=o.length;a>i;r=++i)e=o[r],p+=s.option(r.toString(),e,this.data.day.toString());return p+="</select></div>",this.elem=t(p),u=function(t){return function(){return t.elem.find("span").first().text(function(){switch(this.data.nth){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}.call(t))}}(this),this.elem.find("input").change(function(t){return function(e){return t.data.nth=parseInt(e.target.value),u()}}(this)),this.elem.find("select").change(function(t){return function(e){return t.data.day=parseInt(e.target.value)}}(this)),u(),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),u=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.getData=function(){return this.data.value},n.prototype.fromData=function(t){return this.data.value=t},n.prototype.defaults=function(){return this.data.value=1},n.prototype.render=function(){var e;return e='<div class="DayOfYear">\n  <input type="number" value='+Math.abs(this.data.value)+" /> day from the\n  <select>\n    "+s.option("+","beggening",function(t){return function(){return t.data.value>=0}}(this))+"\n    "+s.option("-","end",function(t){return function(){return t.data.value<0}}(this))+"\n  </select> of the year.</div>",this.elem=t(e),this.elem.find("input,select").change(function(t){return function(e){return t.data.value=parseInt(t.elem.find("input").val()),t.data.value*="+"===t.elem.find("select").val()?1:-1}}(this)),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),h=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.getData=function(){return this.data.value},n.prototype.fromData=function(t){return this.data.value=t},n.prototype.defaults=function(){return this.data.value=1},n.prototype.render=function(){var e,r,i,a,u,o;for(o='<div class="DayOfYear">\n  <select>',u=moment.months(),e=r=0,i=u.length;i>r;e=++r)a=u[e],o+=s.option((e+1).toString(),a,this.data.value.toString());return o+="</select></div>",this.elem=t(o),this.elem.find("input,select").change(function(t){return function(e){return t.data.value=t.elem.find("select").val()}}(this)),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),l=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.getData=function(){return this.data.value},n.prototype.defaults=function(){return this.data.value=0},n.prototype.fromData=function(t){return this.data.value=t},n.prototype.render=function(){var e;return e='<div class="OffsetFromPascha">\n  <input type="number" value='+Math.abs(this.data.value)+" /> days\n  <select>\n    "+s.option("+","after",function(t){return function(){return t.data.value>=0}}(this))+"\n    "+s.option("-","before",function(t){return function(){return t.data.value<0}}(this))+"\n  </select> Pascha.</div>",this.elem=t(e),this.elem.find("input,select").change(function(t){return function(e){return t.data.value=parseInt(t.elem.find("input").val()),t.data.value*="+"===t.elem.find("select").val()?1:-1}}(this)),this.elem.append(n.__super__.render.apply(this,arguments)),this.elem},n}(c),p=function(){function t(t,e){var n,r;n=function(){var e;try{return JSON.parse(t.val())}catch(e){return r=e,null}}(),this.root=new d(t,n),t.parents("form").on("submit",function(n){return function(r){return e.submit?(e.submit(n.getData()),r.preventDefault(),!1):t.val(JSON.stringify(n.getData()))}}(this)),t.after(this.root.render())}return t.prototype.getData=function(){return this.root.getData()},t}(),t.fn.icui=function(e){return null==e&&(e={}),this.each(function(){return new p(t(this),e)})}}(jQuery);